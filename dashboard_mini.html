<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitor Resultados</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:sans-serif;background:#0f172a;color:#f1f5f9;padding:20px}
.container{max-width:1400px;margin:0 auto}
header{text-align:center;margin-bottom:30px}
h1{font-size:2rem;color:#6366f1;margin-bottom:10px}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px}
.stat{background:#1e293b;padding:20px;border-radius:8px;text-align:center;border:1px solid #334155}
.stat-value{font-size:1.8rem;color:#6366f1;font-weight:700}
.stat-label{color:#94a3b8;font-size:0.9rem;margin-top:5px}
.controls{margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap}
.btn{background:#6366f1;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer}
.btn:hover{background:#4f46e5}
a{text-decoration:none;transition:opacity 0.2s}
a:hover{opacity:0.9}
.select{background:#1e293b;color:#f1f5f9;border:1px solid #334155;padding:10px;border-radius:6px;min-width:200px}
.input-date{background:#1e293b;color:#f1f5f9;border:1px solid #334155;padding:10px;border-radius:6px;min-width:180px;font-size:0.9rem}
.input-date::-webkit-calendar-picker-indicator{filter:invert(1);cursor:pointer}
.grupo{background:#1e293b;border-radius:8px;padding:20px;margin-bottom:25px;border:1px solid #334155}
.grupo-header{display:flex;align-items:center;gap:15px;margin-bottom:15px;padding-bottom:15px;border-bottom:2px solid #6366f1;flex-wrap:wrap}
.grupo-titulo{font-size:1.3rem;color:#6366f1;font-weight:700;flex:1}
.grupo-horario{background:#334155;color:#94a3b8;padding:6px 12px;border-radius:4px;font-size:0.9rem}
.grupo-count{background:#8b5cf6;color:white;padding:6px 12px;border-radius:4px;font-size:0.9rem}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
.card{background:#1e293b;border:1px solid #334155;border-radius:6px;padding:15px;text-align:center}
.numero{font-size:1.8rem;color:#6366f1;font-weight:700;margin-bottom:8px}
.animal{font-size:1rem;color:#f1f5f9;text-transform:capitalize}
.timestamp{font-size:0.75rem;color:#94a3b8;margin-top:10px;padding-top:10px;border-top:1px solid #334155}
.empty{text-align:center;padding:40px;color:#94a3b8}
</style>
</head>
<body>
<div class="container">
<header>
<h1>üé∞ Monitor de Resultados</h1>
<p>Resultados do Bicho Certo</p>
<a href="/dashboard-bot" style="display:inline-block;margin-top:15px;background:#10b981;color:white;padding:10px 20px;border-radius:6px;text-decoration:none;font-weight:600">ü§ñ Painel do Bot</a>
</header>
<div class="stats">
<div class="stat"><div class="stat-value" id="total">0</div><div class="stat-label">Total</div></div>
<div class="stat"><div class="stat-value" id="ultima">N/A</div><div class="stat-label">√öltima Verifica√ß√£o</div></div>
<div class="stat"><div class="stat-value" id="loterias">0</div><div class="stat-label">Loterias</div></div>
</div>
<div class="controls">
<button class="btn" onclick="carregar()">üîÑ Atualizar</button>
<select class="select" id="filtro" onchange="filtrar()"><option value="">Todas</option></select>
<input type="date" class="input-date" id="filtro-data" onchange="filtrar()" title="Filtrar por data">
<button class="btn" onclick="limparFiltros()" style="background:#64748b">üóëÔ∏è Limpar Filtros</button>
</div>
<div id="container"></div>
</div>
<script>
let dados=[];
let dadosFiltrados=[];

function extrairData(resultado){
if(resultado.data_extracao){
const partes=resultado.data_extracao.split('/');
if(partes.length===3){
const ano=partes[2].trim();
const mes=partes[1].trim().padStart(2,'0');
const dia=partes[0].trim().padStart(2,'0');
if(ano.length===4&&mes.length===2&&dia.length===2){
return `${ano}-${mes}-${dia}`;
}
}
}
if(resultado.timestamp){
try{
const dt=new Date(resultado.timestamp);
if(!isNaN(dt.getTime())){
const ano=dt.getFullYear();
const mes=String(dt.getMonth()+1).padStart(2,'0');
const dia=String(dt.getDate()).padStart(2,'0');
return `${ano}-${mes}-${dia}`;
}
}catch(e){}
}
return null;
}

async function carregar(){
try{
const r=await fetch('/api/resultados/organizados?'+Date.now());
const d=await r.json();
const organizados=d.organizados||{};
dados=[];
for(const loteria in organizados){
for(const horario in organizados[loteria]){
const resultados=organizados[loteria][horario];
if(Array.isArray(resultados)){
resultados.forEach(r=>{
dados.push({
loteria:loteria,
horario:horario,
numero:r.numero||'',
animal:r.animal||'',
posicao:r.posicao||0,
colocacao:r.colocacao||'',
data_extracao:r.data_extracao||'',
timestamp:r.timestamp||new Date().toISOString(),
estado:r.estado||'BR'
});
});
}
}
}
// Debug: verificar quantos resultados da Loteria Nacional foram carregados
const lnResultados=dados.filter(r=>r.loteria==='Loteria Nacional');
if(lnResultados.length>0){
const horariosLN=[...new Set(lnResultados.map(r=>r.horario))];
console.log(`üîç DEBUG: Loteria Nacional - ${lnResultados.length} resultados em ${horariosLN.length} hor√°rios:`,horariosLN);
}
dadosFiltrados=dados;
document.getElementById('total').textContent=dados.length;
if(d.ultima_verificacao){
const dt=new Date(d.ultima_verificacao);
const options={timeZone:'America/Sao_Paulo',day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'};
document.getElementById('ultima').textContent=dt.toLocaleString('pt-BR',options);
}
const lot=new Set(dados.map(x=>x.loteria));
document.getElementById('loterias').textContent=lot.size;
const sel=document.getElementById('filtro');
sel.innerHTML='<option value="">Todas</option>';
[...lot].sort().forEach(l=>{const o=document.createElement('option');o.value=l;o.textContent=l;sel.appendChild(o);});
renderizar();
}catch(e){
console.error('Erro ao carregar:',e);
document.getElementById('container').innerHTML='<div class="empty">Erro ao carregar: '+e.message+'</div>';
}
}
function renderizar(){
const c=document.getElementById('container');
if(dadosFiltrados.length===0){c.innerHTML='<div class="empty">Nenhum resultado encontrado</div>';return;}
const grupos={};
dadosFiltrados.forEach(r=>{
// Agrupar por loteria + hor√°rio (cada hor√°rio j√° √© um sorteio √∫nico)
// O endpoint j√° organiza por hor√°rio, ent√£o n√£o precisamos agrupar por data aqui
const k=`${r.loteria}_${r.horario||'N/A'}`;
if(!grupos[k]){
grupos[k]={loteria:r.loteria,horario:r.horario||'N/A',resultados:[]};
}
grupos[k].resultados.push(r);
});
// Ordenar: primeiro por loteria, depois por hor√°rio (decrescente para mostrar mais recente primeiro)
const ord=Object.values(grupos).sort((a,b)=>{
if(a.loteria!==b.loteria)return a.loteria.localeCompare(b.loteria);
// Ordenar hor√°rios numericamente (17h > 15h > 12h > 10h > 8h > 2h)
const horaA=parseInt((a.horario||'0').replace(/[^0-9]/g,''))||0;
const horaB=parseInt((b.horario||'0').replace(/[^0-9]/g,''))||0;
return horaB-horaA;
});
c.innerHTML=ord.map(g=>{
g.resultados.sort((a,b)=>(a.posicao||999)-(b.posicao||999));
const cards=g.resultados.map(r=>{
let dt;
try{
dt=r.timestamp?new Date(r.timestamp):new Date();
if(isNaN(dt.getTime()))dt=new Date();
}catch(e){dt=new Date();}
const dataFormatada=dt.toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
const dataISO=extrairData(r)||'';
const posicao=r.colocacao||(r.posicao?r.posicao+'¬∞':'');
return`<div class="card" data-loteria="${r.loteria}" data-data="${dataISO}" data-posicao="${r.posicao||0}"><div class="posicao" style="font-size:0.7rem;color:#94a3b8;margin-bottom:5px">${posicao}</div><div class="numero">${r.numero}</div><div class="animal">${r.animal}</div><div class="timestamp">${dataFormatada}</div></div>`;
}).join('');
return`<div class="grupo" data-loteria="${g.loteria}"><div class="grupo-header"><h3 class="grupo-titulo">${g.loteria}</h3><span class="grupo-horario">üïê ${g.horario}</span><span class="grupo-count">${g.resultados.length}</span></div><div class="grid">${cards}</div></div>`;
}).join('');
}
function filtrar(){
const filtroLoteria=document.getElementById('filtro').value;
const inputData=document.getElementById('filtro-data');
const filtroData=inputData.value;

if(!filtroData||filtroData.length!==10||!filtroData.match(/^\d{4}-\d{2}-\d{2}$/)){
dadosFiltrados=dados.filter(r=>{
return !filtroLoteria||r.loteria===filtroLoteria;
});
document.getElementById('total').textContent=dadosFiltrados.length;
renderizar();
return;
}

dadosFiltrados=dados.filter(r=>{
const passaLoteria=!filtroLoteria||r.loteria===filtroLoteria;
const dataResultado=extrairData(r);
if(!dataResultado)return false;
return passaLoteria&&dataResultado===filtroData;
});

document.getElementById('total').textContent=dadosFiltrados.length;
renderizar();
}

function limparFiltros(){
document.getElementById('filtro').value='';
document.getElementById('filtro-data').value='';
dadosFiltrados=dados;
document.getElementById('total').textContent=dados.length;
renderizar();
}
carregar();
setInterval(carregar,30000);
</script>
</body>
</html>
